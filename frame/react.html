<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 专题 | 前端小梁</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/fe/img/logo.png">
    <meta name="description" content="前端工程">
    <meta name="keywords" content="前端空间">
    
    <link rel="preload" href="/fe/assets/css/0.styles.2519444e.css" as="style"><link rel="preload" href="/fe/assets/js/app.331c70e3.js" as="script"><link rel="preload" href="/fe/assets/js/2.17d60f83.js" as="script"><link rel="preload" href="/fe/assets/js/1.6a888610.js" as="script"><link rel="preload" href="/fe/assets/js/30.b4999e3f.js" as="script"><link rel="prefetch" href="/fe/assets/js/10.a9d975be.js"><link rel="prefetch" href="/fe/assets/js/11.1b1030c8.js"><link rel="prefetch" href="/fe/assets/js/12.c1aff2a0.js"><link rel="prefetch" href="/fe/assets/js/13.08aa9917.js"><link rel="prefetch" href="/fe/assets/js/14.59076001.js"><link rel="prefetch" href="/fe/assets/js/15.a6074940.js"><link rel="prefetch" href="/fe/assets/js/16.d3f28060.js"><link rel="prefetch" href="/fe/assets/js/17.ef2a2a56.js"><link rel="prefetch" href="/fe/assets/js/18.6de233c4.js"><link rel="prefetch" href="/fe/assets/js/19.d6922f6a.js"><link rel="prefetch" href="/fe/assets/js/20.747060c8.js"><link rel="prefetch" href="/fe/assets/js/21.4c406446.js"><link rel="prefetch" href="/fe/assets/js/22.deb2fa6d.js"><link rel="prefetch" href="/fe/assets/js/23.66f4a9a2.js"><link rel="prefetch" href="/fe/assets/js/24.f064ac15.js"><link rel="prefetch" href="/fe/assets/js/25.e1638813.js"><link rel="prefetch" href="/fe/assets/js/26.9b9a86a6.js"><link rel="prefetch" href="/fe/assets/js/27.30bd710f.js"><link rel="prefetch" href="/fe/assets/js/28.c71ee8f6.js"><link rel="prefetch" href="/fe/assets/js/29.3cd83b72.js"><link rel="prefetch" href="/fe/assets/js/3.4bfb056a.js"><link rel="prefetch" href="/fe/assets/js/31.d3ee606f.js"><link rel="prefetch" href="/fe/assets/js/32.e320a6c4.js"><link rel="prefetch" href="/fe/assets/js/33.33b543f7.js"><link rel="prefetch" href="/fe/assets/js/4.daf19725.js"><link rel="prefetch" href="/fe/assets/js/5.eff0709b.js"><link rel="prefetch" href="/fe/assets/js/6.ec81d580.js"><link rel="prefetch" href="/fe/assets/js/7.86371d52.js"><link rel="prefetch" href="/fe/assets/js/vendors~docsearch.03d43e08.js">
    <link rel="stylesheet" href="/fe/assets/css/0.styles.2519444e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe/" class="home-link router-link-active"><img src="/fe/img/logo.png" alt="前端小梁" class="logo"> <span class="site-name can-hide">前端小梁</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe/index.html" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/coding/javascript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/HTTP.html" class="nav-link">
  http
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/datastructure.html" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/algorithm.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端框架" class="mobile-dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/frame/react.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/fe/frame/vue3.x.html" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/fe/frame/vue2.x.html" class="nav-link">
  Vue2
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/engineering/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/fe/engineering/vite.html" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="npm" class="dropdown-title"><span class="title">npm</span> <span class="arrow down"></span></button> <button type="button" aria-label="npm" class="mobile-dropdown-title"><span class="title">npm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/eslint-config-q-eslint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  eslint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/q-markdownlint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdownlint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/commitlint-config-q-commitlint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  commitlint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/q-stylelint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  stylelint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://www.npmjs.com/package/q-lint" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CLI
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://joe-leong.github.io/q-hooks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Hooks
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/joe-leong/fe" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe/index.html" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/coding/javascript.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/HTTP.html" class="nav-link">
  http
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/datastructure.html" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/fe/coding/algorithm.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端框架" class="mobile-dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/frame/react.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/fe/frame/vue3.x.html" class="nav-link">
  Vue3
</a></li><li class="dropdown-item"><!----> <a href="/fe/frame/vue2.x.html" class="nav-link">
  Vue2
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe/engineering/webpack.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/fe/engineering/vite.html" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="npm" class="dropdown-title"><span class="title">npm</span> <span class="arrow down"></span></button> <button type="button" aria-label="npm" class="mobile-dropdown-title"><span class="title">npm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/eslint-config-q-eslint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  eslint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/q-markdownlint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdownlint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/commitlint-config-q-commitlint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  commitlint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/package/q-stylelint-config" target="_blank" rel="noopener noreferrer" class="nav-link external">
  stylelint-config
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://www.npmjs.com/package/q-lint" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CLI
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://joe-leong.github.io/q-hooks" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Hooks
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/joe-leong/fe" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React 专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe/frame/react.html#_1-1-受控组件" class="sidebar-link">1.1. 受控组件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fe/frame/react.html#_1-2-jsx" class="sidebar-link">1.2. jsx</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fe/frame/react.html#_1-3-fiber" class="sidebar-link">1.3. Fiber</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fe/frame/react.html#_2-1-render-阶段" class="sidebar-link">2.1. render 阶段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-1-1-beginwork" class="sidebar-link">2.1.1. beginWork</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-1-2-completework" class="sidebar-link">2.1.2. completeWork</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-1-3-effectlist" class="sidebar-link">2.1.3. effectList</a></li></ul></li><li><a href="/fe/frame/react.html#_2-2-触发更新" class="sidebar-link">2.2. 触发更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-2-1-触发更新方式" class="sidebar-link">2.2.1. 触发更新方式</a></li></ul></li><li><a href="/fe/frame/react.html#_2-3-问题" class="sidebar-link">2.3. 问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-3-1-更新时workinprogress-tree如何生成" class="sidebar-link">2.3.1. 更新时workinprogress tree如何生成？</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-3-2-优先级插队如何实现" class="sidebar-link">2.3.2. 优先级插队如何实现？</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-3-3-如何生成新的-fiber-链呢" class="sidebar-link">2.3.3. 如何生成新的 fiber 链呢？</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_2-3-4-生成的真实节点如何合并的呢" class="sidebar-link">2.3.4. 生成的真实节点如何合并的呢？</a></li></ul></li><li><a href="/fe/frame/react.html#_3-1-渲染优化" class="sidebar-link">3.1. 渲染优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-1-rerender-三要素" class="sidebar-link">3.1.1. ReRender 三要素</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-2-自顶向下更新" class="sidebar-link">3.1.2. 自顶向下更新</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-3-抽离变的部分" class="sidebar-link">3.1.3. 抽离变的部分</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-4-优化父组件" class="sidebar-link">3.1.4. 优化父组件</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-5-context-传参" class="sidebar-link">3.1.5. context 传参</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-6-memo" class="sidebar-link">3.1.6. memo</a></li><li class="sidebar-sub-header"><a href="/fe/frame/react.html#_3-1-7-usememo" class="sidebar-link">3.1.7. useMemo</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-专题"><a href="#react-专题" class="header-anchor">#</a> React 专题</h1> <h1 id="_1-概念"><a href="#_1-概念" class="header-anchor">#</a> 1. 概念</h1> <h2 id="_1-1-受控组件"><a href="#_1-1-受控组件" class="header-anchor">#</a> 1.1. 受控组件</h2> <ul><li>受控组件
对于某个组件，它的状态是否收到外界的控制，如 <code>input</code> 的值是否受 <code>value</code> 控制，并且改变的值通过 <code>change</code> 改变外界的值</li> <li>非受控组件
对应地，组件的状态不受外界控制，如 <code>input</code> 只传入 <code>defaultValue</code> 作为初始值</li></ul> <h2 id="_1-2-jsx"><a href="#_1-2-jsx" class="header-anchor">#</a> 1.2. jsx</h2> <p>jsx 是一种描述当前组件内容的数据结构</p> <h2 id="_1-3-fiber"><a href="#_1-3-fiber" class="header-anchor">#</a> 1.3. Fiber</h2> <ul><li><p>Fiber 是一种架构</p> <p>通过保存的信息链接整个 fiber 树</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Fiber，用来链接其他fiber节点形成的fiber树</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Fiber 是一种数据结构</p> <ul><li><p>储存节点的静态信息以及动态信息</p> <ul><li><p>静态信息</p> <p>每个 <code>fiber</code> 节点都对应着一个 <code>react element</code>，保存了该组件的类型（函数组件，类组件，原生组件对应的 <code>dom</code> 节点信息）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Instance，静态节点的数据结构属性</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>动态信息</p> <p>保存了每个组件改变的状态，要执行的工作（删除，插入或者更新）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// 作为动态的工作单元的属性</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul></li> <li><p>Fiber 是一种更新机制</p> <p>保存着更新的优先级，副作用等，节点之间通过单向链链接，可随时被高优先级或者申请执行时间不够而被中断</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>subtreeTag <span class="token operator">=</span> NoSubtreeEffect<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// 作为调度优先级的属性</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token comment">// 指向该fiber在另一次更新时对应的fiber</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h1 id="_2-源码"><a href="#_2-源码" class="header-anchor">#</a> 2. 源码</h1> <h2 id="_2-1-render-阶段"><a href="#_2-1-render-阶段" class="header-anchor">#</a> 2.1. render 阶段</h2> <h3 id="_2-1-1-beginwork"><a href="#_2-1-1-beginwork" class="header-anchor">#</a> 2.1.1. beginWork</h3> <p><code>beginWork</code>的工作是传入<code>当前Fiber节点</code>，创建<code>子Fiber节点</code>，通过 current===null 判断是 mount 还是 update</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span>
</code></pre></div><h4 id="_2-1-1-1-update"><a href="#_2-1-1-1-update" class="header-anchor">#</a> 2.1.1.1. update</h4> <p>满足一定条件时可以复用<code>current节点</code>，这样就能克隆<code>current.child</code>作为<code>workInProgress.child</code></p> <ul><li>didReceiveUpdate === false
<ul><li>oldProps === newProps &amp;&amp; workInProgress.type === current.type (props 和 fiber.type 不变)</li> <li>!includesSomeLane(renderLanes,updateLanes)，当前<code>fiber节点</code>优先级不够</li></ul></li></ul> <h4 id="_2-1-1-2-mount"><a href="#_2-1-1-2-mount" class="header-anchor">#</a> 2.1.1.2. mount</h4> <p>除<code>fiberRootNode</code>以外，会根据<code>fiber.tag</code>不同，创建不同类型的<code>子fiber节点</code>，最终调用的是<code>recocileChildren</code>，最终都会生成新的<code>Fiber</code>节点返回并赋值给<code>workInProgress.child</code></p> <ul><li>对于<code>mount</code>的组件，会创建新的<code>fiber节点</code></li> <li>对于<code>update</code>的组件，会与<code>current</code>进行对比（<code>diff</code>算法），将比较结果生成新的<code>fiber节点</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">nextChildren</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对于mount的组件</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderLanes
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对于update的组，会带上effectTag属性</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderLanes
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-1-2-completework"><a href="#_2-1-2-completework" class="header-anchor">#</a> 2.1.2. completeWork</h3> <p>与<code>beginWork</code>一样通过判断<code>current !== null</code> 来判断是<code>mount</code> 还是<code>update</code></p> <p>处理<code>props</code>等参数，提交<code>commit</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">completeWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span> FiberNode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__LOG__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;complete流程&quot;</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新</span>
        <span class="token comment">// TODO 更新元素属性</span>
        <span class="token comment">// 不应该在此处调用updateFiberProps，应该跟着判断属性变化的逻辑，在这里打flag</span>
        <span class="token comment">// 再在commitWork中更新fiberProps，我准备把这个过程留到「属性变化」相关需求一起做</span>
        <span class="token function">updateFiberProps</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化DOM</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 挂载DOM</span>
        <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>

        <span class="token comment">// TODO 初始化元素属性</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 冒泡flag</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新</span>
        <span class="token keyword">const</span> oldText <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token operator">?.</span>content<span class="token punctuation">;</span>
        <span class="token keyword">const</span> newText <span class="token operator">=</span> newProps<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldText <span class="token operator">!==</span> newText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">markUpdate</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化DOM</span>
        <span class="token keyword">const</span> textInstance <span class="token operator">=</span> <span class="token function">createTextInstance</span><span class="token punctuation">(</span>newProps<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> textInstance<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 冒泡flag</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;completeWork未定义的fiber.tag&quot;</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-1-2-1-update"><a href="#_2-1-2-1-update" class="header-anchor">#</a> 2.1.2.1. update</h4> <p>判断<code>current</code>的同时还需要判断<code>workInProgress.stateNode</code>，如果不为<code>null</code>则是<code>update</code>,主要处理的 prop：</p> <ul><li><code>onClick</code>、<code>onChange</code>等事件注册</li> <li>处理<code>style</code></li> <li>处理<code>children prop</code></li></ul> <p>最终处理完的<code>props</code>会被赋值给<code>workInProgress.updateQueue</code>,最后在<code>commit</code>阶段被渲染，<code>props</code>是一个数组，基数值为<code>key</code>，偶数值为<code>value</code></p> <h4 id="_2-1-2-2-mount"><a href="#_2-1-2-2-mount" class="header-anchor">#</a> 2.1.2.2. mount</h4> <p>主要逻辑：</p> <ul><li>通过<code>beginWork</code>生成的 tag 为 fiber 节点生成 DOM 节点</li> <li>将子 DOM 节点插入到刚刚生成的 DOM 节点中</li> <li>与<code>update</code>步骤中的<code>updateHostComponent</code>类似的<code>props</code>处理过程</li></ul> <p>每次都把生成的 DOM 节点插入到父亲节点中，<code>commit</code>后只需把<code>rootFiber</code>的<code>stateNode</code>插入到<code>fiberRoot</code>即可以更新全文档</p> <h3 id="_2-1-3-effectlist"><a href="#_2-1-3-effectlist" class="header-anchor">#</a> 2.1.3. effectList</h3> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>v18 已经进行重构，变为<code>subtreeFlags</code>，通过冒泡传递到<code>rootFiber</code>，最终还得遍历树处理<code>effect</code></p></div> <p><a href="https://juejin.cn/post/7036155759121399821" target="_blank" rel="noopener noreferrer">关于 effectList 重构为 subtreeFlags<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>commit阶段</code>需要对存在<code>effectTag</code>的<code>fiber节点</code>进行对应的操作，来源一条叫<code>effectList</code>的单向链表</p> <p>在<code>completeWork</code>中的上层<code>completeUnitOfWork</code>中，每执行完<code>completeWork</code>且存在<code>effectTag</code>，就会把<code>fiber节点</code>添加到该链表中</p> <h2 id="_2-2-触发更新"><a href="#_2-2-触发更新" class="header-anchor">#</a> 2.2. 触发更新</h2> <h3 id="_2-2-1-触发更新方式"><a href="#_2-2-1-触发更新方式" class="header-anchor">#</a> 2.2.1. 触发更新方式</h3> <ul><li>render</li> <li>setState</li> <li>dispatch reducer</li> <li>forceUpdate</li></ul> <h2 id="_2-3-问题"><a href="#_2-3-问题" class="header-anchor">#</a> 2.3. 问题</h2> <h3 id="_2-3-1-更新时workinprogress-tree如何生成"><a href="#_2-3-1-更新时workinprogress-tree如何生成" class="header-anchor">#</a> 2.3.1. 更新时workinprogress tree如何生成？</h3> <h3 id="_2-3-2-优先级插队如何实现"><a href="#_2-3-2-优先级插队如何实现" class="header-anchor">#</a> 2.3.2. 优先级插队如何实现？</h3> <h3 id="_2-3-3-如何生成新的-fiber-链呢"><a href="#_2-3-3-如何生成新的-fiber-链呢" class="header-anchor">#</a> 2.3.3. 如何生成新的 fiber 链呢？</h3> <p>那就是在<code>beginworke</code>里，在处理子节点时调用的<code>reconcileChildFibers</code> 然后调用<code>reconcileSingleElement</code>下层调用 <code>useFiber</code> 产生<code>alternate</code>，最后<code>commitRoot</code>更新视图</p> <h3 id="_2-3-4-生成的真实节点如何合并的呢"><a href="#_2-3-4-生成的真实节点如何合并的呢" class="header-anchor">#</a> 2.3.4. 生成的真实节点如何合并的呢？</h3> <p><code>beginwork</code>的时候对 fiber 完成 tag 的标记，<code>completework</code>时向上遍历，如果判断是原生节点就调用<code>appendAllChildren</code>把子节点添加到当前节点下，<code>fiber</code>保存 DOM 的字段是<code>stateNode</code></p> <h1 id="_3-优化"><a href="#_3-优化" class="header-anchor">#</a> 3. 优化</h1> <h2 id="_3-1-渲染优化"><a href="#_3-1-渲染优化" class="header-anchor">#</a> 3.1. 渲染优化</h2> <h3 id="_3-1-1-rerender-三要素"><a href="#_3-1-1-rerender-三要素" class="header-anchor">#</a> 3.1.1. ReRender 三要素</h3> <p><code>props 默认是全等比较，每次传入的 props 都是全新的对象，oldProps !== newProps true</code></p> <ul><li>props
<code>从父组件接受 data children 等参数</code></li> <li>state
<code>作为 props 传递给子孙组件</code></li> <li>context
<code>从 provider 中获取数据</code></li></ul> <h3 id="_3-1-2-自顶向下更新"><a href="#_3-1-2-自顶向下更新" class="header-anchor">#</a> 3.1.2. 自顶向下更新</h3> <p>在<code>React</code>中数据发生变化，会自顶向下构建一颗完整的组件树，即使组件内部没有发生变化，默认都会被重新渲染</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>input
        type<span class="token operator">=</span><span class="token string">&quot;number&quot;</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token operator">+</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>num is <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ExpensiveCpn <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">ExpensiveCpn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;耗时组件 render&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>耗时组件<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-3-抽离变的部分"><a href="#_3-1-3-抽离变的部分" class="header-anchor">#</a> 3.1.3. 抽离变的部分</h3> <p>把 Input 及展示需要用到 state 的部分抽离成一个组件，把变与不变分离</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Demo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Input<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Input<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ExpensiveCpn <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>input
        type<span class="token operator">=</span><span class="token string">&quot;number&quot;</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token operator">+</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>num is <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-4-优化父组件"><a href="#_3-1-4-优化父组件" class="header-anchor">#</a> 3.1.4. 优化父组件</h3> <p><code>父组件不变，props 传递不变组件到可变组件中，也可以达到不变组件不重渲染</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Demo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>InputWrapper<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ExpensiveCpn <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>InputWrapper<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">InputWrapper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div title<span class="token operator">=</span><span class="token punctuation">{</span>count <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>input
        type<span class="token operator">=</span><span class="token string">&quot;number&quot;</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token operator">+</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>num is <span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-5-context-传参"><a href="#_3-1-5-context-传参" class="header-anchor">#</a> 3.1.5. context 传参</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numCtx <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> updateNumCtx <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Demo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>numCtx<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>updateNumCtx<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>updateNum<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Middle<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Middle<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>updateNumCtx<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>numCtx<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Middle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Show<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Show<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateNum <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>updateNumCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;btn render&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>随机数<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> num <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>numCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>num is<span class="token operator">:</span> <span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-6-memo"><a href="#_3-1-6-memo" class="header-anchor">#</a> 3.1.6. memo</h3> <p><code>使用memo对中间组件的渲染结果缓存，原理是 memo 会对 props 进行浅比较</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Middle <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Show<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Show<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-1-7-usememo"><a href="#_3-1-7-usememo" class="header-anchor">#</a> 3.1.7. useMemo</h3> <p><code>使用 useMemo 对渲染结果缓存</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">Middle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Show<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Show<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="_4-相关库"><a href="#_4-相关库" class="header-anchor">#</a> 4. 相关库</h1> <p>immutable.js
React-app-rewired</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/joe-leong/fe/edit/master/docs/frame/react.md" target="_blank" rel="noopener noreferrer">为该章节纠错</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/9/16 17:53:48</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/fe/assets/js/app.331c70e3.js" defer></script><script src="/fe/assets/js/2.17d60f83.js" defer></script><script src="/fe/assets/js/1.6a888610.js" defer></script><script src="/fe/assets/js/30.b4999e3f.js" defer></script>
  </body>
</html>
